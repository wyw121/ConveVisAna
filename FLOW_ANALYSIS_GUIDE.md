# å¯¹è¯æµç¨‹åˆ†æä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

å¯¹è¯æµç¨‹åˆ†æå™¨ (`conversation_flow_analyzer.py`) æ˜¯ä¸€ä¸ªç”¨äº**åˆ†æå®Œæ•´å¯¹è¯è¿‡ç¨‹**çš„å·¥å…·,èƒ½å¤Ÿè¯†åˆ«:

- ğŸ¯ **é«˜ä»·å€¼é—®é¢˜**: èƒ½å¼•å‘æœ‰ç”¨å›ç­”çš„é—®é¢˜
- âŒ **ä½ä»·å€¼é—®é¢˜**: æ— æ„ä¹‰/é‡å¤/åé¢˜çš„é—®é¢˜  
- ğŸ”„ **è¯é¢˜è½¬ç§»**: å¯¹è¯ä¸»é¢˜çš„è·³è½¬ç‚¹
- ğŸ“Š **é—®é¢˜ç±»å‹åˆ†å¸ƒ**: æ¾„æ¸…æ€§ã€æ·±å…¥æ€§ã€æƒ…æ„Ÿæ€§ã€æŠ€æœ¯æ€§ç­‰

## ğŸ†š ä¸è´¨é‡è¯„ä¼°çš„åŒºåˆ«

### åŸæœ‰çš„è´¨é‡è¯„ä¼° (`evaluate_chats.py`)
- è¯„ä¼°**å•ä¸ªé—®ç­”å¯¹**çš„è´¨é‡
- 6ä¸ªæŒ‡æ ‡: ç›¸å…³æ€§ã€æœ‰ç”¨æ€§ã€è¿è´¯æ€§ã€åŒç†å¿ƒã€æ¯’æ€§ã€åè§
- é€‚ç”¨äº: **è¯„ä¼°å›ç­”è´¨é‡**

### æ–°å¢çš„æµç¨‹åˆ†æ (`conversation_flow_analyzer.py`)  
- åˆ†æ**æ•´ä¸ªå¯¹è¯å‘å±•**è¿‡ç¨‹
- è¯†åˆ«: é—®é¢˜ä»·å€¼ã€è¯é¢˜è¿ç»­æ€§ã€å¯¹è¯æ•ˆç‡
- é€‚ç”¨äº: **ç†è§£å¯¹è¯åŠ¨æ€,å‘ç°å“ªäº›é—®é¢˜æ¨åŠ¨äº†æœ‰æ•ˆäº¤æµ**

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œå¯¹è¯æµç¨‹åˆ†æ

```powershell
# è‡ªåŠ¨é€‰æ‹©æœ€é•¿çš„å¯¹è¯è¿›è¡Œåˆ†æ
python conversation_flow_analyzer.py
```

### 2. æŸ¥çœ‹åˆ†æç»“æœ

åˆ†æç»“æœä¿å­˜åœ¨: `evaluation_results/conversation_flow_analysis.json`

åŒ…å«:
- **å®Œæ•´å›åˆåˆ†æ**: æ¯ä¸€è½®çš„é—®é¢˜ç±»å‹ã€ä»·å€¼ç­‰çº§ã€æ˜¯å¦åŸºäºå‰æ–‡ã€æ˜¯å¦è¯é¢˜è½¬ç§»
- **é«˜ä»·å€¼é—®é¢˜åˆ—è¡¨**: æ ‡æ³¨å“ªäº›é—®é¢˜å¼•å‘äº†é«˜è´¨é‡å›ç­”
- **ä½ä»·å€¼é—®é¢˜åˆ—è¡¨**: æ ‡æ³¨å“ªäº›æ˜¯æ— æ„ä¹‰é—®é¢˜
- **è¯é¢˜è½¬ç§»ç‚¹**: å¯¹è¯ä¸»é¢˜è·³è½¬çš„ä½ç½®
- **æµç¨‹æ‘˜è¦**: å¯¹è¯æ•ˆç‡ã€é—®é¢˜ç±»å‹åˆ†å¸ƒç­‰ç»Ÿè®¡æ•°æ®

## ğŸ“Š åˆ†æç»´åº¦è¯¦è§£

### é—®é¢˜ç±»å‹ (question_type)

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `clarifying` | æ¾„æ¸…æ€§é—®é¢˜ | "èƒ½ä¸¾ä¸ªä¾‹å­å—?" |
| `deepening` | æ·±å…¥æ€§é—®é¢˜ | "è¿™ä¸ªæ–¹æ¡ˆçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆ?" |
| `emotional` | æƒ…æ„Ÿæ€§é—®é¢˜ | "æˆ‘è¯¥æ€ä¹ˆåŠ?" |
| `technical` | æŠ€æœ¯æ€§é—®é¢˜ | "å¦‚ä½•é…ç½®ç¯å¢ƒ?" |
| `off-topic` | åé¢˜/é—²èŠ | "ä»Šå¤©å¤©æ°”ä¸é”™" |

### ä»·å€¼ç­‰çº§ (value_level)

- **high**: é«˜ä»·å€¼é—®é¢˜ - èƒ½å¼•å‘æœ‰ç”¨å›ç­”
- **medium**: ä¸­ç­‰ä»·å€¼
- **low**: ä½ä»·å€¼ - æ— æ„ä¹‰/é‡å¤

### å…¶ä»–æŒ‡æ ‡

- **builds_on_previous**: æ˜¯å¦åŸºäºå‰æ–‡å†…å®¹ (true/false)
- **topic_shift**: æ˜¯å¦å‘ç”Ÿè¯é¢˜è½¬ç§» (true/false)

## ğŸ“ˆ åˆ†æç»“æœç¤ºä¾‹

```json
{
  "conversation_title": "æ¯›æ³½ä¸œä¸é‚“å°å¹³ç†è®º",
  "total_turns": 20,
  "flow_summary": {
    "total_turns": 20,
    "high_value_ratio": 0.55,        // 55% é«˜ä»·å€¼é—®é¢˜
    "low_value_ratio": 0.0,          // 0% ä½ä»·å€¼é—®é¢˜
    "topic_shifts_count": 5,         // 5æ¬¡è¯é¢˜è½¬ç§»
    "efficiency_score": 0.55,        // å¯¹è¯æ•ˆç‡åˆ†æ•°
    "question_type_distribution": {
      "technical": 17,               // 17ä¸ªæŠ€æœ¯æ€§é—®é¢˜
      "deepening": 1,                // 1ä¸ªæ·±å…¥æ€§é—®é¢˜
      "clarifying": 2                // 2ä¸ªæ¾„æ¸…æ€§é—®é¢˜
    }
  },
  "high_value_turns": [
    {
      "turn_index": 1,
      "question": "æ¯›æ³½ä¸œæ€æƒ³ã€é‚“å°å¹³ç†è®ºæ˜¯ä¸­å›½åŒ–äº†çš„é©¬å…‹æ€ä¸»ä¹‰...",
      "type": "technical",
      "reason": "è¿™æ˜¯ä¸€ä¸ªå¤šé€‰é¢˜ï¼Œå±äºæŠ€æœ¯æ€§é—®é¢˜ï¼Œå…·æœ‰æ˜ç¡®çš„æ•™è‚²å’Œæµ‹è¯•ä»·å€¼"
    }
  ]
}
```

## ğŸ› ï¸ è‡ªå®šä¹‰åˆ†æ

### åˆ†æç‰¹å®šå¯¹è¯

```python
from conversation_flow_analyzer import ConversationFlowAnalyzer
from custom_llm import create_deepseek_chat
from data_loader import ChatDataLoader
import os
from dotenv import load_dotenv

load_dotenv()

# åˆ›å»ºæ¨¡å‹
api_key = os.getenv('CHATAI_API_KEY')
model = create_deepseek_chat(api_key)

# åŠ è½½æ•°æ®
data_path = "ä½ çš„æ•°æ®æ–‡ä»¶å¤¹è·¯å¾„"
loader = ChatDataLoader(data_path)
conversations = loader.load_conversations()

# é€‰æ‹©ç¬¬3ä¸ªå¯¹è¯
conv = conversations[2]
turns = loader.get_conversation_turns(conv)

# åˆ†æ
analyzer = ConversationFlowAnalyzer(model)
results = analyzer.analyze_conversation_flow(turns, conv.title)

# ä¿å­˜
analyzer.save_analysis(results, 'my_analysis.json')
```

### æ‰¹é‡åˆ†ææ‰€æœ‰å¯¹è¯

```python
for i, conv in enumerate(conversations):
    turns = loader.get_conversation_turns(conv)
    
    if len(turns) < 3:  # è·³è¿‡å¤ªçŸ­çš„å¯¹è¯
        continue
    
    results = analyzer.analyze_conversation_flow(turns, conv.title)
    analyzer.save_analysis(
        results, 
        f'evaluation_results/flow_analysis_{i+1}.json'
    )
```

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### 1. å‘ç°å¯¹è¯æ¨¡å¼
- è¯†åˆ«å“ªäº›ç±»å‹çš„é—®é¢˜æœ€å¸¸è§
- åˆ†æå¯¹è¯æ˜¯å¦æœ‰æ¸…æ™°çš„æ¨è¿›é€»è¾‘

### 2. ä¼˜åŒ–æé—®ç­–ç•¥
- æ‰¾åˆ°é«˜ä»·å€¼é—®é¢˜çš„ç‰¹å¾
- é¿å…ä½ä»·å€¼/é‡å¤æ€§é—®é¢˜

### 3. è¯„ä¼°å¯¹è¯è´¨é‡
- è®¡ç®—å¯¹è¯æ•ˆç‡åˆ†æ•°
- æ£€æµ‹æ— æ•ˆçš„è¯é¢˜è·³è½¬

### 4. æ”¹è¿› AI åŠ©æ‰‹
- åˆ†æç”¨æˆ·çœŸæ­£å…³å¿ƒçš„é—®é¢˜ç±»å‹
- è¯†åˆ«éœ€è¦æ¾„æ¸…çš„åœºæ™¯

## âš™ï¸ é…ç½®è¯´æ˜

åˆ†æå™¨ä½¿ç”¨ LLM è¿›è¡Œæ™ºèƒ½åˆ†æ,éœ€è¦é…ç½®:

```bash
# .env æ–‡ä»¶
CHATAI_API_KEY=ä½ çš„APIå¯†é’¥
```

å½“å‰ä½¿ç”¨ **DeepSeek Chat** æ¨¡å‹,æˆæœ¬ä½å»‰ä¸”æ•ˆæœè‰¯å¥½ã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **API è°ƒç”¨é‡**: æ¯è½®å¯¹è¯ä¼šè°ƒç”¨1æ¬¡ LLM API
   - 20è½®å¯¹è¯ = 20æ¬¡ API è°ƒç”¨
   - å»ºè®®å…ˆæµ‹è¯•å°å¯¹è¯,å†æ‰¹é‡åˆ†æ

2. **åˆ†ææ—¶é—´**: å–å†³äºå¯¹è¯é•¿åº¦
   - 1è½®å¯¹è¯ ~2ç§’
   - 20è½®å¯¹è¯ ~40ç§’

3. **ç»“æœå‡†ç¡®æ€§**: LLM åˆ†ææœ‰ä¸»è§‚æ€§
   - å»ºè®®å¯¹å…³é”®ç»“æœè¿›è¡Œäººå·¥éªŒè¯
   - å¯é€šè¿‡è°ƒæ•´æç¤ºè¯ä¼˜åŒ–åˆ†ææ•ˆæœ

## ğŸ”§ è¿›é˜¶å®šåˆ¶

### ä¿®æ”¹åˆ†ææç¤ºè¯

ç¼–è¾‘ `conversation_flow_analyzer.py` ä¸­çš„ `_analyze_single_turn` æ–¹æ³•:

```python
prompt = f"""ä½ æ˜¯ä¸€ä¸ªå¯¹è¯è´¨é‡åˆ†æä¸“å®¶ã€‚åˆ†æä»¥ä¸‹ç”¨æˆ·é—®é¢˜...

[åœ¨è¿™é‡Œè‡ªå®šä¹‰åˆ†ææ ‡å‡†å’Œè¾“å‡ºæ ¼å¼]
"""
```

### æ·»åŠ æ–°çš„åˆ†æç»´åº¦

åœ¨ `_analyze_single_turn` çš„ JSON è¿”å›ä¸­æ·»åŠ æ–°å­—æ®µ,ä¾‹å¦‚:

```python
{
    'question_type': ...,
    'value_level': ...,
    'emotional_tone': 'positive/negative/neutral',  # æ–°å¢
    'complexity_level': 'beginner/intermediate/advanced'  # æ–°å¢
}
```

## ğŸ“ ç–‘éš¾è§£ç­”

### Q: åˆ†æç»“æœä¸ºç©º?
A: æ£€æŸ¥å¯¹è¯æ˜¯å¦åŒ…å«å®Œæ•´çš„é—®ç­”å¯¹ (user â†’ assistant)

### Q: æŠ¥é”™ "AttributeError"?
A: ç¡®ä¿ä½¿ç”¨ `get_conversation_turns()` è€Œéæ—§ç‰ˆæ–¹æ³•

### Q: åˆ†æé€Ÿåº¦æ…¢?
A: å¯¹è¯è¶Šé•¿è°ƒç”¨æ¬¡æ•°è¶Šå¤š,å¯ä»¥é™åˆ¶åˆ†æå‰Nè½®:
```python
turns = turns[:10]  # åªåˆ†æå‰10è½®
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è´¨é‡è¯„ä¼°æŒ‡å—](README.md) - å•ä¸ªé—®ç­”å¯¹è´¨é‡è¯„ä¼°
- [æ•°æ®åŠ è½½å™¨æ–‡æ¡£](data_loader.py) - æ•°æ®è§£æé€»è¾‘
- [è‡ªå®šä¹‰ LLM é…ç½®](custom_llm.py) - API é›†æˆ

---

**å¼€å‘è€…**: GitHub Copilot  
**æœ€åæ›´æ–°**: 2025-01-18
